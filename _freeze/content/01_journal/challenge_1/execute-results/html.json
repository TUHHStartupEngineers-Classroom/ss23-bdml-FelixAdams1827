{
  "hash": "c7b43b0c77c61deaf12f499e20c52cc6",
  "result": {
    "markdown": "---\ntitle: \"Challenge 1\"\nauthor: \"Felix Adamaszek\"\n---\n\n\n# Loading libraries and data\n\n\n::: {.cell hash='challenge_1_cache/html/unnamed-chunk-1_b18c32652606a7dc3812913e5e871193'}\n\n```{.r .cell-code}\n# Load libraries \n    library(tidyverse)\n    library(tidyquant)\n    library(broom)\n    library(umap)\n    library(readr)\n    library(readxl)\n\n# STOCK PRICES and SECTOR INFORMATION\n\n  sp_500_prices_tbl <- read_rds(\"/Users/felixadamaszek/Documents/GitHub/ss23-bdml-FelixAdams1827/ss23-bdml-FelixAdams1827/content/01_journal/FUNDAMENTAL_DOWNLOADS/sp_500_prices_tbl.rds\")\n  \n  sp_500_index_tbl <- read_rds(\"/Users/felixadamaszek/Documents/GitHub/ss23-bdml-FelixAdams1827/ss23-bdml-FelixAdams1827/content/01_journal/FUNDAMENTAL_DOWNLOADS/sp_500_index_tbl.rds\")\n```\n:::\n\n\n# Conversion of the stock prices to a standardized format (daily returns)\n\n\n::: {.cell hash='challenge_1_cache/html/unnamed-chunk-2_198159bed23f99c767df99c2bce3ff99'}\n\n```{.r .cell-code}\n  sp_500_daily_returns_tbl <- sp_500_prices_tbl %>% \n  select(symbol, date, adjusted) %>% \n  filter(date >= '2018-01-01') %>% \n  group_by(symbol) %>% \n  mutate(lag = lag(adjusted)) %>% \n  na.omit %>% \n  mutate(pct_return = (adjusted - lag)/lag) %>% \n  select(symbol, date, pct_return)\n```\n:::\n\n\n# Conversion to the User-Item format\n\n\n::: {.cell hash='challenge_1_cache/html/unnamed-chunk-3_b85aedf771b43f2fdfe29cc6f102db15'}\n\n```{.r .cell-code}\n  stock_date_matrix_tbl <- sp_500_daily_returns_tbl %>% \n  spread(date, pct_return) %>% \n  replace(is.na(.),0) %>% \n  ungroup()\n```\n:::\n\n\n# Performing K-Means clustering\n\n\n::: {.cell hash='challenge_1_cache/html/unnamed-chunk-4_5aec95e628b544e2bdb87fc226aac207'}\n\n```{.r .cell-code}\n  kmeans_obj <- stock_date_matrix_tbl %>% \n  within(rm(\"symbol\")) %>% \n  kmeans(centers = 4, nstart = 20)\n```\n:::\n\n\n# Finding the optimal value of K\n\n\n::: {.cell hash='challenge_1_cache/html/unnamed-chunk-5_01c4b02bca33415ee17d213a669b6bbe'}\n\n```{.r .cell-code}\nkmeans_mapper <- function(center = 3) {\n  stock_date_matrix_tbl %>%\n    select(-symbol) %>%\n    kmeans(centers = center, nstart = 20)\n}\n\nk_means_mapped_tbl <- tibble(centers = 1:30) %>% \n  mutate(k_means = centers %>%  map(kmeans_mapper)) %>% \n  mutate(glance = k_means %>% map(glance))\n  \nk_means_mapped_tbl %>% \n  unnest(glance) %>% \n  select(centers, tot.withinss) %>% \n  \n  \n# Visualization of tot.withinss\n  \n  ggplot(aes(centers, tot.withinss)) +\n  geom_point(color = \"#2DC6D6\", size = 5) +\n  geom_line(color = \"#2DC6D6\", linewidth = 2) +\n  # Add labels (which are repelled a little)\n  ggrepel::geom_label_repel(aes(label = centers), color = \"#2DC6D6\") + \n  \n# Formatting\n  \n  labs(title = \"Skree Plot\")\n```\n\n::: {.cell-output-display}\n![](challenge_1_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n# Application of UMAP\n\n\n::: {.cell hash='challenge_1_cache/html/unnamed-chunk-6_0211d4983aa6f56bf7601701feaf115a'}\n\n```{.r .cell-code}\numap_results <- stock_date_matrix_tbl %>% \n  select(-symbol) %>% \n  umap()\n\numap_results_tbl <- umap_results$layout %>% \n  as_tibble(.name_repair = \"unique\") %>% \n  set_names(c(\"x\", \"y\")) %>%\n  bind_cols(stock_date_matrix_tbl %>% select(symbol)) \n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> New names:\n#> • `` -> `...1`\n#> • `` -> `...2`\n```\n:::\n\n```{.r .cell-code}\numap_results_tbl %>% \n  ggplot(aes(x, y), ) +\n  geom_point(alpha = 0.5) + \n  theme_tq() + \n  ggrepel::geom_label_repel(aes(label = symbol), size = 3) + \n  labs(title = \"UMAP Projection\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: ggrepel: 500 unlabeled data points (too many overlaps). Consider\n#> increasing max.overlaps\n```\n:::\n\n::: {.cell-output-display}\n![](challenge_1_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n# Combination of K-Means and UMAP\n\n\n::: {.cell hash='challenge_1_cache/html/unnamed-chunk-7_20dfb0ebae48d9f7b197189696e596e0'}\n\n```{.r .cell-code}\numap_kmeans_results_tbl <- kmeans_obj %>% \n  augment(stock_date_matrix_tbl) %>% \n  select(symbol, .cluster) %>% \n  left_join(umap_results_tbl) %>% \n  left_join(sp_500_index_tbl %>% select(symbol, company, sector))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Joining with `by = join_by(symbol)`\n#> Joining with `by = join_by(symbol)`\n```\n:::\n\n```{.r .cell-code}\numap_kmeans_results_tbl %>% \n  ggplot(aes(x, y, color = .cluster)) +\n  \n# Geometries\n\n  geom_point(alpha = 0.5) +\n  ggrepel::geom_label_repel(aes(label = symbol), size = 2, fill = \"#282A36\") +\n  \n  # Formatting\n\n  scale_color_manual(values=c(\"#2d72d6\", \"#2dc6d6\", \"#2dd692\", \"#2dd692\")) + \n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: ggrepel: 497 unlabeled data points (too many overlaps). Consider\n#> increasing max.overlaps\n```\n:::\n\n::: {.cell-output-display}\n![](challenge_1_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}